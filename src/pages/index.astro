---
import Layout from '../layouts/Layout.astro';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { AllDonationItemsQuery } from '~/lib/datocms/queries/AllDonationItemsQuery';
import DonationCard from '~/components/DonationCard/Component.astro';
import DonationModal from '~/components/DonationModal/Component.astro'; // Import DonationModal
import type { DonationItem } from '~/lib/types';

const { allDonationItems } = await executeQuery(AllDonationItemsQuery);

// Type guard to ensure GraphQL data matches expected DonationItem structure
function isDonationItem(item: unknown): item is DonationItem {
  return (
    typeof item === 'object' &&
    item !== null &&
    'id' in item &&
    'title' in item &&
    'personName' in item &&
    'description' in item &&
    'image' in item &&
    typeof (item as any).id === 'string' &&
    typeof (item as any).title === 'string' &&
    typeof (item as any).personName === 'string' &&
    typeof (item as any).description === 'string' &&
    typeof (item as any).image === 'object' &&
    (item as any).image !== null &&
    'url' in (item as any).image &&
    typeof (item as any).image.url === 'string'
  );
}

function isDonationItemArray(data: unknown): data is DonationItem[] {
  return Array.isArray(data) && data.every(isDonationItem);
}

const typedAllDonationItems: DonationItem[] = isDonationItemArray(allDonationItems)
  ? allDonationItems
  : [];
---

<Layout title="Donatale">
  <h1 class="text-4xl font-bold text-center my-8">Donazioni Disponibili</h1>
  <div
    id="donation-cards-container"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4"
  >
    {
      typedAllDonationItems.length === 0 ? (
        <p class="col-span-full text-center text-lg">
          Nessun oggetto disponibile per la donazione al momento. Torna presto!
        </p>
      ) : (
        typedAllDonationItems.map((item) => <DonationCard item={item} />)
      )
    }
  </div>

  <DonationModal />
</Layout>

<script>
  import { initDonationModal } from '../scripts/donation-modal.ts';

  // Initialize the donation modal when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    initDonationModal();
  });
</script>
