---
import Layout from '../layouts/Layout.astro';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { isDraftModeEnabled } from '~/lib/draftMode';
import { DraftModeQueryListener } from '~/components/DraftModeQueryListener';
import { AllDonationItemsQuery } from '~/lib/datocms/queries/AllDonationItemsQuery';
import DonationCard from '~/components/DonationCard/Component.astro';
import DonationModal from '~/components/DonationModal/Component.astro'; // Import DonationModal
import type { DonationItem } from '~/lib/types';

const draftModeEnabled = isDraftModeEnabled(Astro.cookies);
const { allDonationItems } = await executeQuery(AllDonationItemsQuery, {
  includeDrafts: draftModeEnabled,
});

const typedAllDonationItems: DonationItem[] = allDonationItems as DonationItem[];
---

<Layout title="Donatale">
  <h1 class="text-4xl font-bold text-center my-8">Donazioni Disponibili</h1>
  <div
    id="donation-cards-container"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4"
  >
    {
      typedAllDonationItems.length === 0 ? (
        <p class="col-span-full text-center text-lg">
          Nessun oggetto disponibile per la donazione al momento. Torna presto!
        </p>
      ) : (
        typedAllDonationItems.map((item) => <DonationCard item={item} />)
      )
    }
  </div>
  <DraftModeQueryListener query={AllDonationItemsQuery} />

  <DonationModal />
</Layout>

<script is:inline>
  const donationModal = document.getElementById('donation-modal');
  const donationCardsContainer = document.getElementById('donation-cards-container');
  const donationForm = document.getElementById('donation-form');
  const modalCloseButton = document.getElementById('modal-close-button'); // Get the close button

  // Helper to safely set an HTMLInputElement value
  function setInputElementValue(id, value) {
    const element = document.getElementById(id);
    if (element instanceof HTMLInputElement) {
      element.value = value;
    }
  }

  if (donationCardsContainer && donationModal && donationForm && modalCloseButton) {
    // Function to populate and show the modal
    function showDonationModal(itemData) {
      if (!donationModal) return;

      // Populate modal content
      document.getElementById('modal-item-title').textContent = itemData.title;
      document.getElementById('modal-item-description').textContent = itemData.description;
      document.getElementById('modal-donation-code').textContent = itemData.donationCode;

      const modalImage = document.getElementById('modal-item-image');
      if (itemData.imageUrl && modalImage instanceof HTMLImageElement) {
        modalImage.src = itemData.imageUrl;
        modalImage.classList.remove('hidden');
      } else if (modalImage) {
        modalImage.classList.add('hidden');
      }

      // Populate hidden form fields
      setInputElementValue('form-item-id', itemData.id);
      setInputElementValue('form-donation-code', itemData.donationCode);

      // Reset donor specific fields
      setInputElementValue('donorName', '');
      setInputElementValue('donorEmail', '');
      setInputElementValue('donatedBy', '');

      donationModal.showModal();
    }

    // Event listener for opening the modal
    donationCardsContainer.addEventListener('click', (event) => {
      const targetButton = event.target.closest('button[data-item-id]');
      if (targetButton && !targetButton.disabled) {
        const itemData = {
          id: targetButton.dataset.itemId || '',
          title: targetButton.dataset.itemTitle || '',
          personName: targetButton.dataset.itemPersonName || '',
          description: targetButton.dataset.itemDescription || '',
          imageUrl: targetButton.dataset.itemImageUrl || '',
          donationCode: targetButton.dataset.donationCode || '',
        };
        showDonationModal(itemData);
      }
    });

    // Event listener for closing the modal using the 'X' button
    modalCloseButton.addEventListener('click', () => {
      donationModal.close();
    });

    // Handle form submission (will call backend API)
    donationForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target; // event.target will be the form element

      if (!(form instanceof HTMLFormElement)) {
        console.error('Event target is not an HTMLFormElement.');
        return;
      }

      const formData = new FormData(form);

      const donorName = String(formData.get('donorName'));
      const donorEmail = String(formData.get('donorEmail'));
      let donatedBy = String(formData.get('donatedBy'));
      const itemId = String(formData.get('itemId'));
      const donationCode = String(formData.get('donationCode'));

      if (!donatedBy) {
        donatedBy = donorName; // Default donatedBy to donorName if not provided
      }

      const submissionData = {
        itemId: itemId,
        donationCode: donationCode,
        donorName: donorName,
        donorEmail: donorEmail,
        donatedBy: donatedBy,
      };

      console.log('Form submitted:', submissionData);

      // Backend API call
      try {
        const response = await fetch('/api/donate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(submissionData),
        });

        const result = await response.json();

        if (response.ok) {
          console.log('API response:', result);
          donationModal.close();
          alert(
            'Grazie per la tua donazione! Abbiamo registrato la tua intenzione e riceverai presto una email di conferma.',
          );
          window.location.reload();
        } else {
          console.error('API error:', result);
          alert(`Errore nella donazione: ${result.message || 'Si è verificato un errore.'}`);
        }
      } catch (error) {
        console.error('Network or unexpected error:', error);
        alert('Si è verificato un errore inaspettato. Riprova più tardi.');
      }
    });

    // Close modal when clicking outside (native <dialog> behavior)
    donationModal.addEventListener('click', (event) => {
      if (event.target === donationModal) {
        donationModal.close();
      }
    });
  }
</script>
